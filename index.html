<!DOCTYPE html>
<html lang="en" x-data="surveyApp()" x-init="init()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Expo Feedback</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Confetti -->
  <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 relative">

  <!-- GLOBAL HEADER -->
  <div x-show="step>1" class="absolute top-4 right-4 flex items-center space-x-4">
    <img src="https://cdn.bndleu.com/expoMumbai2025/areumLogo.png" class="h-8" alt="Logo"/>
    <button @click="viewStats()" class="text-sm text-blue-600 underline hover:text-blue-800">Stats</button>
    <button @click="logout()"     class="text-sm text-red-600  underline hover:text-red-800">Logout</button>
  </div>

  <!-- STEP 1: LOGIN -->
  <template x-if="step===1">
    <div class="max-w-md w-full bg-white p-6 rounded-xl shadow-lg space-y-4">
      <img src="https://cdn.bndleu.com/expoMumbai2025/areumLogo.png" class="h-12 mx-auto" alt="Logo"/>
      <h2 class="text-2xl font-semibold text-center">Team Login</h2>
      <input x-model="nameLogin"     type="text"     placeholder="Name"     class="w-full p-3 border rounded"/>
      <input x-model="passwordLogin" type="password" placeholder="Password" class="w-full p-3 border rounded"/>
      <button @click="login()"
              :disabled="!nameLogin||!passwordLogin||loading"
              class="w-full py-3 bg-blue-500 text-white rounded disabled:opacity-50">
        <span x-text="loading ? 'â€¦' : 'Login'"></span>
      </button>
    </div>
  </template>

  <!-- STEP 2: LANGUAGE -->
  <template x-if="step===2">
    <div class="max-w-md w-full bg-white p-6 rounded-xl shadow-lg space-y-4">
      <h2 class="text-2xl font-semibold text-center">Choose Language</h2>
      <template x-for="lang in languages" :key="lang.code">
        <label class="flex items-center space-x-3 p-3 border rounded cursor-pointer">
          <input type="radio" name="lang" :value="lang.code" x-model="selectedLanguage" class="form-radio"/>
          <span x-text="lang.label"></span>
        </label>
      </template>
      <button @click="step=3"
              :disabled="!selectedLanguage"
              class="w-full py-3 bg-blue-500 text-white rounded">Next</button>
    </div>
  </template>

  <!-- STEP 3: ROLE -->
  <template x-if="step===3">
    <div class="max-w-md w-full bg-white p-6 rounded-xl shadow-lg space-y-4">
      <h2 class="text-2xl font-semibold text-center">What best describes you?</h2>
      <template x-for="role in roles" :key="role.id">
        <label class="flex items-center space-x-3 p-3 border rounded cursor-pointer">
          <input type="radio" name="role" :value="role.id" x-model="selectedRole" class="form-radio"/>
          <span x-text="role.label"></span>
        </label>
      </template>
      <button @click="step=4"
              :disabled="!selectedRole"
              class="w-full py-3 bg-blue-500 text-white rounded">Next</button>
    </div>
  </template>

  <!-- STEP 4: BRAND -->
  <template x-if="step===4">
    <div class="max-w-md w-full bg-white p-6 rounded-xl shadow-lg space-y-4">
      <h2 class="text-2xl font-semibold text-center">Select Brand</h2>
      <template x-for="brand in brands" :key="brand.id">
        <label class="flex items-center space-x-3 p-3 border rounded cursor-pointer">
          <input type="radio" name="brand" :value="brand.id" x-model="selectedBrand" class="form-radio"/>
          <img :src="brand.logoUrl" class="h-8 w-8 object-contain" alt="Brand"/>
          <span x-text="brand.name"></span>
        </label>
      </template>
      <button @click="startSurvey()"
              :disabled="!selectedBrand"
              class="w-full py-3 bg-blue-500 text-white rounded">Next</button>
    </div>
  </template>

  <!-- STEP 5: DYNAMIC QUESTIONS -->
  <template x-if="step===5">
    <div class="max-w-md w-full bg-white p-6 rounded-xl shadow-lg space-y-6">
      <h2 class="text-xl font-semibold text-center">
        {{ currentQuestionIndex+1 }} of {{ totalQuestions }}:
        <span x-text="currentQuestion.text"></span>
      </h2>
      <!-- rating -->
      <div x-show="currentQuestion.type==='rating'" class="flex justify-center space-x-2">
        <template x-for="i in 5" :key="i">
          <svg @click="recordAnswer(i)"
               :class="answers[currentQuestionIndex]>=i ? 'text-yellow-400' : 'text-gray-300'"
               class="h-10 w-10 cursor-pointer transition-colors"
               fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927C...Z"/>
          </svg>
        </template>
      </div>
      <!-- text -->
      <div x-show="currentQuestion.type==='text'">
        <textarea x-model="answers[currentQuestionIndex]"
                  rows="3"
                  class="w-full p-3 border rounded"></textarea>
      </div>
      <button @click="nextQuestion()"
              :disabled="!answers[currentQuestionIndex]"
              class="w-full py-3 bg-blue-500 text-white rounded">Next</button>
    </div>
  </template>

  <!-- STEP 6: CONTACT -->
  <template x-if="step===6">
    <div class="max-w-md w-full bg-white p-6 rounded-xl shadow-lg space-y-4">
      <h2 class="text-xl font-semibold text-center">Your Contact Info</h2>

      <!-- B2B -->
      <template x-if="selectedRole==='b2b'">
        <input x-model="companyName" type="text"     placeholder="Company Name" class="w-full p-3 border rounded"/>
        <input x-model="email"       type="email"    placeholder="Work Email"   class="w-full p-3 border rounded"/>
        <input x-model="phone"       type="tel"      placeholder="Work Phone"   maxlength="10" class="w-full p-3 border rounded"/>
      </template>

      <!-- D2C -->
      <template x-if="selectedRole==='d2c'">
        <input x-model="email" type="email" placeholder="Email"             class="w-full p-3 border rounded"/>
        <input x-model="phone" type="tel"   placeholder="Phone (optional)" maxlength="10" class="w-full p-3 border rounded"/>
      </template>

      <button @click="submit()"
              :disabled="!contactValid"
              class="w-full py-3 bg-green-500 text-white rounded">Submit</button>
    </div>
  </template>

  <!-- STEP 7: THANK YOU -->
  <template x-if="step===7">
    <div class="max-w-md w-full bg-white p-6 rounded-xl shadow-lg text-center space-y-4">
      <h2 class="text-2xl">Thank you! ðŸŽ‰</h2>
      <p>Your feedback has been recorded.</p>
      <button @click="resetSurvey(); step=4"
              class="w-full py-3 bg-blue-500 text-white rounded">Another Survey</button>
    </div>
  </template>

  <!-- STEP 8: STATS -->
  <template x-if="step===8">
    <div class="max-w-3xl w-full bg-white p-6 rounded-xl shadow-lg space-y-6 overflow-auto max-h-screen">
      <h2 class="text-2xl font-semibold text-center">Survey Statistics</h2>

      <div class="grid grid-cols-2 gap-4">
        <div>Total Responses: <strong x-text="stats.totalResponses"/></div>
        <div>B2B: <strong x-text="stats.countByRole.b2b"/></div>
        <div>D2C: <strong x-text="stats.countByRole.d2c"/></div>
        <div>
          Responses per Brand:
          <ul class="list-disc list-inside">
            <template x-for="(cnt, b) in stats.countByBrand" :key="b">
              <li><span x-text="b"/>: <span x-text="cnt"/></li>
            </template>
          </ul>
        </div>
      </div>

      <h3 class="text-xl font-semibold">Question Summaries</h3>
      <template x-for="q in stats.questionStats" :key="q.question">
        <div class="p-4 border rounded space-y-2">
          <div class="font-medium" x-text="q.question"/>
          <ul class="list-disc list-inside">
            <template x-for="opt in q.options" :key="opt.value">
              <li><span x-text="opt.value"/>: <span x-text="opt.count"/></li>
            </template>
          </ul>
        </div>
      </template>

      <h3 class="text-xl font-semibold">All Responses</h3>
      <table class="w-full table-auto border-collapse">
        <thead>
          <tr class="bg-gray-200">
            <th class="border p-2">ID</th>
            <th class="border p-2">Role</th>
            <th class="border p-2">Brand</th>
            <th class="border p-2">Date</th>
            <th class="border p-2">Details</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="r in stats.allResponses" :key="r.id">
            <tr>
              <td class="border p-2" x-text="r.id"/>
              <td class="border p-2" x-text="r.role"/>
              <td class="border p-2" x-text="r.brand_id"/>
              <td class="border p-2" x-text="new Date(r.submitted_at).toLocaleString()"/>
              <td class="border p-2">
                <button @click="viewDetails(r)" class="text-blue-600 underline">View</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </template>

  <!-- Alpine Component -->
  <script>
  function surveyApp() {
    return {
      step: 1,
      loading: false,
      authToken: '',
      userId: null,

      // login
      nameLogin: '',
      passwordLogin: '',

      // flow
      languages: [
        { code:'en', label:'English' },
        { code:'hi', label:'Hindi'   },
        { code:'mr', label:'Marathi' }
      ],
      selectedLanguage: '',

      roles: [
        { id:'b2b', label:'Business' },
        { id:'d2c', label:'Consumer' }
      ],
      selectedRole: '',

      brands: [
        { id:'brand1', name:'Molvany',    logoUrl:'https://cdn.bndleu.com/expoMumbai2025/brand1.png' },
        { id:'brand2', name:"Jeu' Demeure", logoUrl:'https://cdn.bndleu.com/expoMumbai2025/brand2.png' },
        { id:'brand3', name:'Vegreen',    logoUrl:'https://cdn.bndleu.com/expoMumbai2025/brand3.png' },
        { id:'brand4', name:'DailyCha-e', logoUrl:'https://cdn.bndleu.com/expoMumbai2025/brand4.png' },
        { id:'brand5', name:'AreumSkincare', logoUrl:'https://cdn.bndleu.com/expoMumbai2025/brand5.png' }
      ],
      selectedBrand: '',

      // dynamic Qs
      questions: {},
      currentQuestionIndex: 0,
      answers: [],

      // contact
      companyName: '',
      email: '',
      phone: '',

      // stats
      stats: {
        totalResponses: 0,
        countByRole: { b2b:0, d2c:0 },
        countByBrand: {},
        questionStats: [],
        allResponses: []
      },

      // getters
      get currentQuestion() {
        return this.questions[this.selectedBrand][this.selectedRole][this.currentQuestionIndex];
      },
      get totalQuestions() {
        return this.questions[this.selectedBrand][this.selectedRole].length;
      },
      get contactValid() {
        if (this.selectedRole === 'b2b') {
          return this.companyName && this.email && this.phone.length === 10;
        }
        return this.email || this.phone.length === 10;
      },

      init() {
        // restore session
        const t = sessionStorage.getItem('authToken');
        if (t) {
          this.authToken = t;
          this.userId    = JSON.parse(atob(t.split('.')[1])).id;
          this.step      = 2;
        }

        // build dummy questions (5 per brandÃ—role)
        this.brands.forEach(b => {
          this.questions[b.id] = {};
          ['b2b','d2c'].forEach(r => {
            this.questions[b.id][r] = Array.from({ length:5 }, (_, i) => ({
              type: i % 2 === 0 ? 'rating' : 'text',
              text: `Question ${i+1} for ${b.name} (${r.toUpperCase()})`
            }));
          });
        });
      },

      async login() {
        this.loading = true;
        try {
          const res = await fetch('/api/auth/login', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ name:this.nameLogin, password:this.passwordLogin })
          });
          if (!res.ok) throw new Error('Invalid credentials');
          const { token } = await res.json();
          sessionStorage.setItem('authToken', token);
          this.authToken = token;
          this.userId    = JSON.parse(atob(token.split('.')[1])).id;
          this.step      = 2;
        } catch (e) {
          alert('Login failed');
        } finally {
          this.loading = false;
        }
      },

      startSurvey() {
        this.answers = Array(this.totalQuestions).fill(null);
        this.currentQuestionIndex = 0;
        this.step = 5;
      },

      recordAnswer(val) {
        this.answers[this.currentQuestionIndex] = val;
      },

      nextQuestion() {
        if (this.currentQuestionIndex + 1 < this.totalQuestions) {
          this.currentQuestionIndex++;
        } else {
          this.step = 6;
        }
      },

      async submit() {
        this.loading = true;
        try {
          const payload = {
            language:     this.selectedLanguage,
            role:         this.selectedRole,
            brandId:      this.selectedBrand,
            answers:      this.answers,
            companyName:  this.selectedRole==='b2b' ? this.companyName : null,
            name:         this.selectedRole==='d2c' ? this.companyName : null,
            email:        this.email,
            phone:        this.phone
          };
          const res = await fetch('/api/survey/submit', {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              Authorization:`Bearer ${this.authToken}`
            },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error('Submit failed');
          this.step = 7;
          confetti({ spread:60, ticks:200 });
        } catch(e) {
          alert('Submit error');
        } finally {
          this.loading = false;
        }
      },

      viewStats() {
        this.step = 8;
        this.loadStats();
      },

      async loadStats() {
        try {
          const res = await fetch('/api/survey/stats', {
            headers:{ Authorization:`Bearer ${this.authToken}` }
          });
          if (!res.ok) throw new Error();
          this.stats = await res.json();
        } catch(e) {
          console.error('Stats load error', e);
        }
      },

      viewDetails(r) {
        alert(JSON.stringify(r, null, 2));
      },

      resetSurvey() {
        this.step = 4;
        this.selectedBrand = '';
        this.currentQuestionIndex = 0;
        this.answers = [];
        this.companyName = this.email = this.phone = '';
      },

      logout() {
        sessionStorage.clear();
        this.step = 1;
      }
    }
  }
  </script>
</body>
</html>
