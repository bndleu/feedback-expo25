<!DOCTYPE html>
<html lang="en" x-data="surveyApp()" x-init="init()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Miricanvas Survey</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 relative">

  <!-- HEADER -->
  <div x-show="step > 1" class="absolute top-4 right-4 flex items-center space-x-4">
    <img src="https://cdn.bndleu.com/expoMumbai2025/brand6.png" class="h-8" alt="Logo"/>
    <button @click="resetSurvey(); step=1" class="text-sm text-yellow-600 underline hover:text-yellow-800">Exit Survey</button>
  </div>

  <!-- STEP 1: Welcome -->
  <template x-if="step === 1">
    <div class="max-w-md w-full bg-white p-6 rounded-xl shadow-lg text-center space-y-6">
      <img src="https://cdn.bndleu.com/expoMumbai2025/brand6.png" class="h-12 mx-auto" alt="Logo"/>
      <h2 class="text-2xl font-semibold">Miricanvas Survey</h2>
      <p class="text-xs text-gray-500">
        By continuing, I consent to the use of my responses and contact information for market research purposes and to receive relevant follow-ups from the participating brand(s), in line with standard data protection and privacy policies.
      </p>
      <button @click="step=2" class="w-full py-3 bg-blue-500 text-white rounded">Begin Survey</button>
    </div>
  </template>

  <!-- Other steps as included in your code -->

<script>
function surveyApp() {
  return {
    step: 1,
    selectedRole: '',
    selectedBrand: 'brand6',
    externalQuestions: {},
    questions: {},
    answers: {},
    currentQuestionIndex: 0,
    companyName: '',
    contactPerson: '',
    email: '',
    phone: '',
    designation: '',
    userId: `guest_${Date.now()}`,
    
    get currentQuestion() {
      return this.questions?.[this.selectedBrand]?.[this.selectedRole]?.[this.currentQuestionIndex] || {};
    },
    get totalQuestions() {
      return this.questions?.[this.selectedBrand]?.[this.selectedRole]?.length || 0;
    },

    init() {
      this.loadExternalQuestions();
    },

    startQuestions() {
      const brand = this.selectedBrand;
      const role = this.selectedRole;
      const brandSpecific = this.getBrandSpecificQuestions(brand, role);
      this.questions[brand] = { [role]: [...brandSpecific] };
      this.answers = {};
      this.currentQuestionIndex = 0;
      this.step = 3;
    },

    recordAnswer(val) {
      const key = this.currentQuestion.text;
      this.answers[key] = val;
    },

    toggleCheckbox(opt) {
      const key = this.currentQuestion.text;
      if (!Array.isArray(this.answers[key])) this.answers[key] = [];
      const index = this.answers[key].indexOf(opt);
      if (index > -1) this.answers[key].splice(index, 1);
      else this.answers[key].push(opt);
    },

    nextQuestion() {
      if (this.currentQuestionIndex + 1 < this.totalQuestions) this.currentQuestionIndex++;
      else this.step = 4;
    },

    prevQuestion() {
      if (this.currentQuestionIndex > 0) this.currentQuestionIndex--;
      else this.step = 2;
    },

    getBrandSpecificQuestions(brandId, role) {
      return this.externalQuestions?.[brandId]?.[role] || [];
    },

    async loadExternalQuestions() {
      try {
        const res = await fetch('/questions.json');
        if (!res.ok) throw new Error();
        this.externalQuestions = await res.json();
      } catch (e) {
        console.error('Failed to load questions:', e);
      }
    },

    saveContactAndSubmit() {
      this.answers["Company Name"] = this.companyName;
      this.answers["Contact Person"] = this.contactPerson;
      this.answers["Work Email"] = this.email;
      this.answers["Phone"] = this.phone;
      this.answers["Designation"] = this.designation;
      this.submit();
    },

    async submit() {
      this.loading = true;
      try {
        const ratingEntry = Object.entries(this.answers).find(([k, v]) => typeof v === 'number');
        const rating = ratingEntry ? ratingEntry[1] : null;
        const commentEntry = Object.entries(this.answers).find(([k, v]) => typeof v === 'string' && v.length > 2);
        const comment = commentEntry ? commentEntry[1] : '';

        const payload = {
          role: this.selectedRole,
          brand: this.selectedBrand,
          rating,
          comment,
          answers: this.answers,
          user_id: this.userId
        };

        const res = await fetch('https://p8u2pge6em.ap-south-1.awsapprunner.com/api/survey/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error();
        this.step = 5;
        confetti({ spread: 60, ticks: 200 });
      } catch {
        alert('Submit error');
      } finally {
        this.loading = false;
      }
    },

    resetSurvey() {
      this.step = 1;
      this.selectedRole = '';
      this.answers = {};
      this.currentQuestionIndex = 0;
      this.companyName = this.contactPerson = this.email = this.phone = this.designation = '';
    }
  }
}
</script>
</body>
</html>
